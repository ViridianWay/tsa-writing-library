---
import { getCollection } from 'astro:content';

interface Props {
	/** The series name to match in frontmatter */
	series: string;
	/** Sort by chapter number (default) or published date */
	sortBy?: 'chapter' | 'published';
}

const { series, sortBy = 'chapter' } = Astro.props as Props;

const docs = await getCollection('docs');

const toPath = (entry: (typeof docs)[number]) => {
	const raw = entry.slug ?? entry.id.replace(/\.(md|mdx)$/, '');
	return `/${raw.replace(/\/index$/, '')}/`;
};

const works = docs
	.filter(
		(entry) =>
			entry.id.startsWith('library/') &&
			!entry.id.endsWith('/index.md') &&
			entry.data.series === series
	)
	.map((entry) => ({
		title: entry.data.title,
		path: toPath(entry),
		part: entry.data.part,
		chapter: entry.data.chapter,
		type: entry.data.type,
		published: entry.data.published,
	}));

// Sort by part then chapter, or by published date
works.sort((a, b) => {
	if (sortBy === 'published') {
		return String(a.published ?? '').localeCompare(String(b.published ?? ''));
	}
	const partA = Number(a.part) || 0;
	const partB = Number(b.part) || 0;
	if (partA !== partB) return partA - partB;
	const chA = Number(a.chapter) || 0;
	const chB = Number(b.chapter) || 0;
	return chA - chB;
});

// Group by part if parts exist
const hasParts = works.some((w) => w.part);
const parts = new Map<number, typeof works>();
if (hasParts) {
	for (const work of works) {
		const p = Number(work.part) || 0;
		const list = parts.get(p) ?? [];
		list.push(work);
		parts.set(p, list);
	}
}
---

{works.length === 0 ? (
	<p>No works found for this collection.</p>
) : hasParts ? (
	<div class="toc-list">
		{[...parts.entries()].sort(([a], [b]) => a - b).map(([partNum, items]) => (
			<section class="toc-part">
				{partNum > 0 && <h3 class="toc-part-title">Part {partNum}</h3>}
				<div class="toc-items">
					{items.map((work) => (
						<a href={work.path} class="toc-item">
							{Number(work.chapter) > 0 && (
								<span class="toc-number">{work.chapter}</span>
							)}
							<span class="toc-title">
								{work.title}
								{work.type === 'Series Overview' && (
									<span class="toc-badge">Overview</span>
								)}
							</span>
						</a>
					))}
				</div>
			</section>
		))}
	</div>
) : (
	<div class="toc-list">
		<div class="toc-items">
			{works.map((work) => (
				<a href={work.path} class="toc-item">
					{Number(work.chapter) > 0 && (
						<span class="toc-number">{work.chapter}</span>
					)}
					<span class="toc-title">
						{work.title}
						{work.type === 'Series Overview' && (
							<span class="toc-badge">Overview</span>
						)}
					</span>
				</a>
			))}
		</div>
	</div>
)}
