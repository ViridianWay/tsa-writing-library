---
interface Props {
	src: string;
	alt: string;
}

const { src, alt } = Astro.props;
---

<figure class="lightbox-figure">
	<img src={src} alt={alt} class="lightbox-thumb" loading="lazy" />
	{alt && <figcaption class="lightbox-caption">{alt}</figcaption>}
</figure>

<div class="lightbox-overlay" aria-hidden="true">
	<button class="lightbox-close" aria-label="Close">&times;</button>
	<img src={src} alt={alt} class="lightbox-full" />
</div>

<script>
	function initLightboxes() {
		document.querySelectorAll<HTMLElement>('.lightbox-figure').forEach((figure) => {
			const overlay = figure.nextElementSibling as HTMLElement;
			if (!overlay?.classList.contains('lightbox-overlay')) return;

			const thumb = figure.querySelector('.lightbox-thumb') as HTMLElement;
			const closeBtn = overlay.querySelector('.lightbox-close') as HTMLElement;

			thumb.addEventListener('click', () => {
				overlay.classList.add('open');
				overlay.setAttribute('aria-hidden', 'false');
			});

			closeBtn.addEventListener('click', () => {
				overlay.classList.remove('open');
				overlay.setAttribute('aria-hidden', 'true');
			});

			overlay.addEventListener('click', (e) => {
				if (e.target === overlay) {
					overlay.classList.remove('open');
					overlay.setAttribute('aria-hidden', 'true');
				}
			});
		});

		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				document.querySelectorAll('.lightbox-overlay.open').forEach((el) => {
					el.classList.remove('open');
					el.setAttribute('aria-hidden', 'true');
				});
			}
		});
	}

	// Run on initial load and on Astro page transitions
	initLightboxes();
	document.addEventListener('astro:after-swap', initLightboxes);
</script>

<style>
	.lightbox-figure {
		margin: 1.5rem 0;
		cursor: zoom-in;
	}

	.lightbox-thumb {
		max-width: 100%;
		border-radius: 0.375rem;
		border: 1px solid var(--sl-color-gray-5);
		transition: opacity 0.15s ease;
	}

	.lightbox-thumb:hover {
		opacity: 0.85;
	}

	.lightbox-caption {
		font-size: 0.8rem;
		color: var(--sl-color-gray-3);
		margin-top: 0.4rem;
		font-style: italic;
		text-align: center;
	}

	.lightbox-overlay {
		display: none;
		position: fixed;
		inset: 0;
		z-index: 9999;
		background: rgba(0, 0, 0, 0.85);
		justify-content: center;
		align-items: center;
		padding: 2rem;
		cursor: zoom-out;
	}

	.lightbox-overlay.open {
		display: flex;
	}

	.lightbox-full {
		max-width: 90vw;
		max-height: 90vh;
		object-fit: contain;
		border-radius: 0.25rem;
		cursor: default;
	}

	.lightbox-close {
		position: absolute;
		top: 1rem;
		right: 1.5rem;
		font-size: 2rem;
		color: white;
		background: none;
		border: none;
		cursor: pointer;
		line-height: 1;
		padding: 0.25rem 0.5rem;
		opacity: 0.8;
		transition: opacity 0.15s ease;
	}

	.lightbox-close:hover {
		opacity: 1;
	}
</style>
