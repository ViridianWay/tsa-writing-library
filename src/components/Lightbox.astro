---
interface Props {
	src: string;
	alt: string;
}

const { src, alt } = Astro.props;
---

<figure class="lightbox-figure" data-lightbox-src={src} data-lightbox-alt={alt}>
	<img src={src} alt={alt} class="lightbox-thumb" loading="lazy" />
	{alt && <figcaption class="lightbox-caption">{alt}</figcaption>}
</figure>

<script>
	function initLightboxes() {
		document.querySelectorAll<HTMLElement>('.lightbox-figure[data-lightbox-src]').forEach((figure) => {
			if (figure.dataset.lbInit) return;
			figure.dataset.lbInit = '1';

			const src = figure.dataset.lightboxSrc!;
			const alt = figure.dataset.lightboxAlt || '';
			const thumb = figure.querySelector('.lightbox-thumb') as HTMLElement;

			// Build overlay and append to body so it escapes any stacking contexts
			const overlay = document.createElement('div');
			overlay.className = 'lightbox-overlay';
			overlay.setAttribute('aria-hidden', 'true');
			overlay.innerHTML = `
				<button class="lightbox-close" aria-label="Close">&times;</button>
				<div class="lightbox-zoom-container">
					<img src="${src}" alt="${alt}" class="lightbox-full" draggable="false" />
				</div>
				<div class="lightbox-hint">Scroll or pinch to zoom</div>
			`;
			document.body.appendChild(overlay);

			const closeBtn = overlay.querySelector('.lightbox-close') as HTMLElement;
			const container = overlay.querySelector('.lightbox-zoom-container') as HTMLElement;
			const img = overlay.querySelector('.lightbox-full') as HTMLElement;
			const hint = overlay.querySelector('.lightbox-hint') as HTMLElement;

			let scale = 1;
			let panX = 0;
			let panY = 0;
			let dragging = false;
			let dragStartX = 0;
			let dragStartY = 0;
			let panStartX = 0;
			let panStartY = 0;

			function applyTransform() {
				img.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
			}

			function resetZoom() {
				scale = 1;
				panX = 0;
				panY = 0;
				applyTransform();
			}

			function openLightbox() {
				resetZoom();
				overlay.classList.add('open');
				overlay.setAttribute('aria-hidden', 'false');
				document.body.style.overflow = 'hidden';
				if (hint) {
					hint.style.opacity = '1';
					setTimeout(() => { hint.style.opacity = '0'; }, 2000);
				}
			}

			function closeLightbox() {
				overlay.classList.remove('open');
				overlay.setAttribute('aria-hidden', 'true');
				document.body.style.overflow = '';
			}

			thumb.addEventListener('click', openLightbox);
			closeBtn.addEventListener('click', closeLightbox);

			overlay.addEventListener('click', (e) => {
				if (e.target === overlay || e.target === container) {
					if (scale > 1) {
						resetZoom();
					} else {
						closeLightbox();
					}
				}
			});

			// Scroll to zoom
			container.addEventListener('wheel', (e) => {
				e.preventDefault();
				const delta = e.deltaY > 0 ? -0.15 : 0.15;
				const newScale = Math.min(Math.max(scale + delta, 0.5), 8);
				const rect = container.getBoundingClientRect();
				const cx = e.clientX - rect.left - rect.width / 2;
				const cy = e.clientY - rect.top - rect.height / 2;
				const ratio = 1 - newScale / scale;
				panX += (cx - panX) * ratio;
				panY += (cy - panY) * ratio;
				scale = newScale;
				applyTransform();
			}, { passive: false });

			// Drag to pan
			container.addEventListener('mousedown', (e) => {
				if (scale <= 1) return;
				e.preventDefault();
				dragging = true;
				dragStartX = e.clientX;
				dragStartY = e.clientY;
				panStartX = panX;
				panStartY = panY;
				container.style.cursor = 'grabbing';
			});

			window.addEventListener('mousemove', (e) => {
				if (!dragging) return;
				panX = panStartX + (e.clientX - dragStartX);
				panY = panStartY + (e.clientY - dragStartY);
				applyTransform();
			});

			window.addEventListener('mouseup', () => {
				if (!dragging) return;
				dragging = false;
				container.style.cursor = '';
			});

			// Touch pinch-to-zoom and drag
			let lastTouchDist = 0;
			let lastTouchX = 0;
			let lastTouchY = 0;

			container.addEventListener('touchstart', (e) => {
				if (e.touches.length === 2) {
					e.preventDefault();
					const dx = e.touches[0].clientX - e.touches[1].clientX;
					const dy = e.touches[0].clientY - e.touches[1].clientY;
					lastTouchDist = Math.hypot(dx, dy);
				} else if (e.touches.length === 1 && scale > 1) {
					lastTouchX = e.touches[0].clientX;
					lastTouchY = e.touches[0].clientY;
				}
			}, { passive: false });

			container.addEventListener('touchmove', (e) => {
				if (e.touches.length === 2) {
					e.preventDefault();
					const dx = e.touches[0].clientX - e.touches[1].clientX;
					const dy = e.touches[0].clientY - e.touches[1].clientY;
					const dist = Math.hypot(dx, dy);
					if (lastTouchDist > 0) {
						scale = Math.min(Math.max(scale * (dist / lastTouchDist), 0.5), 8);
						applyTransform();
					}
					lastTouchDist = dist;
				} else if (e.touches.length === 1 && scale > 1) {
					e.preventDefault();
					panX += e.touches[0].clientX - lastTouchX;
					panY += e.touches[0].clientY - lastTouchY;
					lastTouchX = e.touches[0].clientX;
					lastTouchY = e.touches[0].clientY;
					applyTransform();
				}
			}, { passive: false });

			container.addEventListener('touchend', () => {
				lastTouchDist = 0;
			});

			// Double-click/tap to toggle zoom
			container.addEventListener('dblclick', (e) => {
				e.preventDefault();
				if (scale > 1) {
					resetZoom();
				} else {
					const rect = container.getBoundingClientRect();
					panX = rect.width / 2 - (e.clientX - rect.left);
					panY = rect.height / 2 - (e.clientY - rect.top);
					scale = 3;
					applyTransform();
				}
			});
		});

		// Escape key closes all lightboxes
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				document.querySelectorAll('.lightbox-overlay.open').forEach((el) => {
					el.classList.remove('open');
					el.setAttribute('aria-hidden', 'true');
				});
				document.body.style.overflow = '';
			}
		});

		// Make all PDF links open in new tabs
		document.querySelectorAll<HTMLAnchorElement>('a[href$=".pdf"]').forEach((link) => {
			link.setAttribute('target', '_blank');
			link.setAttribute('rel', 'noopener');
		});
	}

	initLightboxes();
	document.addEventListener('astro:after-swap', initLightboxes);
</script>

<style>
	.lightbox-figure {
		margin: 1.5rem 0;
		cursor: zoom-in;
	}

	.lightbox-thumb {
		max-width: 100%;
		border-radius: 0.375rem;
		border: 1px solid var(--sl-color-gray-5);
		transition: opacity 0.15s ease;
	}

	.lightbox-thumb:hover {
		opacity: 0.85;
	}

	.lightbox-caption {
		font-size: 0.8rem;
		color: var(--sl-color-gray-3);
		margin-top: 0.4rem;
		font-style: italic;
		text-align: center;
	}
</style>

<style is:global>
	.lightbox-overlay {
		display: none;
		position: fixed;
		inset: 0;
		z-index: 9999;
		background: rgba(0, 0, 0, 0.85);
		flex-direction: column;
		justify-content: center;
		align-items: center;
		padding: 0;
	}

	.lightbox-overlay.open {
		display: flex;
	}

	.lightbox-zoom-container {
		width: 100%;
		height: 100%;
		display: flex;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		cursor: grab;
	}

	.lightbox-full {
		max-width: 90vw;
		max-height: 90vh;
		object-fit: contain;
		border-radius: 0.25rem;
		transform-origin: center center;
		transition: none;
		user-select: none;
		-webkit-user-select: none;
	}

	.lightbox-close {
		position: absolute;
		top: 1rem;
		right: 1.5rem;
		font-size: 2rem;
		color: white;
		background: none;
		border: none;
		cursor: pointer;
		line-height: 1;
		padding: 0.25rem 0.5rem;
		opacity: 0.8;
		transition: opacity 0.15s ease;
		z-index: 10000;
	}

	.lightbox-close:hover {
		opacity: 1;
	}

	.lightbox-hint {
		position: absolute;
		bottom: 1.5rem;
		color: rgba(255, 255, 255, 0.7);
		font-size: 0.8rem;
		pointer-events: none;
		transition: opacity 0.5s ease;
	}
</style>
