---
import { getCollection } from 'astro:content';
import { collectionUrls, chapterLabel } from '../lib/collections';

const currentPath = Astro.url.pathname;
const isLibraryPage = currentPath.startsWith('/library/');

let prevLink: { href: string; label: string; partChapter: string } | null = null;
let nextLink: { href: string; label: string; partChapter: string } | null = null;
let collectionLink: { href: string; label: string } | null = null;

if (isLibraryPage) {
	const docs = await getCollection('docs');

	const toPath = (entry: (typeof docs)[number]) => {
		const raw = (entry as any).slug ?? entry.id.replace(/\.(md|mdx)$/, '');
		return `/${raw.replace(/\/index$/, '')}/`;
	};

	const currentDoc = docs.find((doc) => toPath(doc) === currentPath);

	if (currentDoc) {
		const seriesName = (currentDoc.data as any).series as string | undefined;

		if (seriesName) {
			if (collectionUrls[seriesName]) {
				collectionLink = { href: collectionUrls[seriesName], label: seriesName };
			}

			const seriesDocs = docs
				.filter((d) => d.id.startsWith('library/') && (d.data as any).series === seriesName)
				.map((d) => ({
					title: (d.data as any).title as string,
					path: toPath(d),
					part: (d.data as any).part,
					chapter: (d.data as any).chapter,
				}))
				.sort((a, b) => {
					const partA = Number(a.part) || 0;
					const partB = Number(b.part) || 0;
					if (partA !== partB) return partA - partB;
					return (Number(a.chapter) || 0) - (Number(b.chapter) || 0);
				});

			const idx = seriesDocs.findIndex((d) => d.path === currentPath);

			if (idx > 0) {
				const prev = seriesDocs[idx - 1];
				prevLink = {
					href: prev.path,
					label: prev.title,
					partChapter: chapterLabel(prev.part, prev.chapter),
				};
			}
			if (idx >= 0 && idx < seriesDocs.length - 1) {
				const next = seriesDocs[idx + 1];
				nextLink = {
					href: next.path,
					label: next.title,
					partChapter: chapterLabel(next.part, next.chapter),
				};
			}
		}
	}
}
---

{isLibraryPage && (prevLink || nextLink || collectionLink) ? (
	<nav class="chapter-nav" aria-label="Chapter navigation">
		<div class="chapter-nav-links">
			{prevLink ? (
				<a href={prevLink.href} class="chapter-link prev" rel="prev">
					<span class="chapter-dir">&larr; Previous{prevLink.partChapter ? ` · ${prevLink.partChapter}` : ''}</span>
					<span class="chapter-title">{prevLink.label}</span>
				</a>
			) : collectionLink ? (
				<a href={collectionLink.href} class="chapter-link prev">
					<span class="chapter-dir">&larr; Collection</span>
					<span class="chapter-title">{collectionLink.label}</span>
				</a>
			) : (
				<span />
			)}
			{nextLink ? (
				<a href={nextLink.href} class="chapter-link next" rel="next">
					<span class="chapter-dir">Next{nextLink.partChapter ? ` · ${nextLink.partChapter}` : ''} &rarr;</span>
					<span class="chapter-title">{nextLink.label}</span>
				</a>
			) : collectionLink ? (
				<a href={collectionLink.href} class="chapter-link next">
					<span class="chapter-dir">Collection &rarr;</span>
					<span class="chapter-title">{collectionLink.label}</span>
				</a>
			) : (
				<span />
			)}
		</div>
	</nav>
) : null}
